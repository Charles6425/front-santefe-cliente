<div class="cart-container">
  <!-- Estado vazio do carrinho -->
  <div *ngIf="isCartEmpty()" class="empty-cart">
    <div class="empty-icon">
      <i class='bx bx-cart'></i>
    </div>
    <h3 class="empty-title">Carrinho vazio</h3>
    <p class="empty-message">Adicione produtos do cardápio para começar seu pedido</p>
  </div>

  <!-- Header do carrinho com itens -->
  <div *ngIf="!isCartEmpty()" class="cart-header">
    <div class="cart-title">
      <i class='bx bx-cart'></i>
      <h3>Carrinho de Compras</h3>
    </div>
    <span class="items-count">{{ cart.quantidadeItens }} item(s)</span>
  </div>

  <!-- Lista de itens do carrinho -->
  <div *ngIf="!isCartEmpty()" class="cart-items">
    <div *ngFor="let item of cart.items" class="cart-item">
      <div class="item-details">
        <h4 class="item-name">{{ item.nomeProduto }}</h4>
        <span *ngIf="item.categoriaId && getCategoriaNome(item.categoriaId)" class="item-category">
          {{ getCategoriaNome(item.categoriaId) }}
        </span>
        <div class="item-price">R$ {{ item.valorUnitario.toFixed(2) }} (un.)</div>
        <p *ngIf="item.observacao && item.observacao.trim() !== ''" class="item-note">
          <i class='bx bx-note'></i>
          {{ item.observacao }}
        </p>
      </div>
      
      <div class="item-actions">
        <div class="quantity-controls">
          <button 
            class="qty-btn minus" 
            (click)="updateItemQuantity(item.id, item.quantidade - 1)"
            [disabled]="item.quantidade <= 1"
            aria-label="Diminuir quantidade">
            <i class='bx bx-minus'></i>
          </button>
          <span class="quantity">{{ item.quantidade }}</span>
          <button 
            class="qty-btn plus" 
            (click)="updateItemQuantity(item.id, item.quantidade + 1)"
            aria-label="Aumentar quantidade">
            <i class='bx bx-plus'></i>
          </button>
        </div>
        <button 
          class="remove-btn" 
          (click)="removeItem(item.id)"
          aria-label="Remover item do carrinho">
          <i class='bx bx-trash'></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Footer do carrinho com total e formulário -->
  <div *ngIf="!isCartEmpty()" class="cart-footer">
    <!-- Total -->
    <div class="total-section">
      <div class="total-row">
        <span class="total-label">Total do Pedido:</span>
        <span class="total-amount">R$ {{ cart.valorTotal.toFixed(2) }}</span>
      </div>
    </div>

    <!-- Formulário de checkout -->
    <form [formGroup]="checkoutForm" (ngSubmit)="criarSolicitacao()" autocomplete="off" class="order-form">
      <div class="form-section">
        <h4 class="section-title">
          <i class='bx bx-clipboard'></i>
          Dados do Pedido
        </h4>
        
        <!-- Tipo de atendimento -->
        <div class="form-group">
          <label class="form-label">Tipo de Atendimento *</label>
          <div class="service-types">
            <div *ngFor="let tipo of tiposAtendimento" class="service-option-wrapper">
              <input 
                type="radio" 
                [id]="tipo.value" 
                [value]="tipo.value" 
                formControlName="tipoAtendimento"
                name="tipoAtendimento">
              <label [for]="tipo.value" class="service-option">
                <i [ngClass]="tipo.value === 'BALCAO' ? 'bx bx-store' : tipo.value === 'MESA' ? 'bx bx-table' : tipo.value === 'ENTREGA' ? 'bx bx-package' : tipo.value === 'RETIRADA' ? 'bx bx-time' : 'bx bx-help-circle'"></i>
                {{ tipo.label }}
              </label>
            </div>
          </div>
          <div *ngIf="hasRequiredError('tipoAtendimento')" class="error-message">
            {{ getFieldError('tipoAtendimento') }}
          </div>
        </div>

        <!-- Campo para mesa (se tipo MESA) -->
        <div *ngIf="checkoutForm.get('tipoAtendimento')?.value === 'MESA'" class="conditional-fields">
          <div class="form-group">
            <label for="mesa" class="form-label">Número da Mesa *</label>
            <input 
              type="text" 
              id="mesa"
              formControlName="mesa"
              placeholder="Ex: 5"
              class="form-input"
              [class.error]="hasRequiredError('mesa')">
            <div *ngIf="hasRequiredError('mesa')" class="error-message">
              {{ getFieldError('mesa') }}
            </div>
          </div>
        </div>

        <!-- Campos para ENTREGA -->
        <div *ngIf="checkoutForm.get('tipoAtendimento')?.value === 'ENTREGA'" class="conditional-fields">
          <div class="delivery-info">
            <i class='bx bx-time-five'></i>
            <span>Tempo estimado: 30 min a 1 hora</span>
          </div>
          
          <div class="form-group">
            <label for="cpfEntrega" class="form-label">CPF do Cliente *</label>
            <div class="input-with-button">
              <input 
                type="text" 
                id="cpfEntrega"
                formControlName="cpfCliente"
                maxlength="11" 
                minlength="11" 
                placeholder="00000000000"
                class="form-input"
                [class.error]="hasRequiredError('cpfCliente')">
              <button 
                type="button" 
                class="search-btn"
                (click)="buscarClientePorCpf()" 
                [disabled]="buscandoCliente || !checkoutForm.get('cpfCliente')?.value || checkoutForm.get('cpfCliente')?.value.length !== 11">
                <i class='bx bx-search' *ngIf="!buscandoCliente"></i>
                <i class='bx bx-loader-alt rotating' *ngIf="buscandoCliente"></i>
              </button>
            </div>
            <div *ngIf="hasRequiredError('cpfCliente')" class="error-message">
              {{ getFieldError('cpfCliente') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="nomeEntrega" class="form-label">Nome do Cliente *</label>
            <input 
              type="text" 
              id="nomeEntrega"
              formControlName="nomeCliente"
              placeholder="Nome completo"
              class="form-input"
              [class.readonly]="clienteEncontrado"
              [readonly]="clienteEncontrado"
              [class.error]="hasRequiredError('nomeCliente')">
            <div *ngIf="hasRequiredError('nomeCliente')" class="error-message">
              {{ getFieldError('nomeCliente') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="telefoneEntrega" class="form-label">Telefone *</label>
            <input 
              type="tel" 
              id="telefoneEntrega"
              formControlName="telefoneCliente"
              placeholder="(00) 00000-0000"
              class="form-input"
              [class.readonly]="clienteEncontrado"
              [readonly]="clienteEncontrado"
              [class.error]="hasRequiredError('telefoneCliente')">
            <div *ngIf="hasRequiredError('telefoneCliente')" class="error-message">
              {{ getFieldError('telefoneCliente') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="endereco" class="form-label">Endereço para Entrega *</label>
            <input 
              type="text" 
              id="endereco"
              formControlName="enderecoCliente"
              placeholder="Rua, número, bairro"
              class="form-input"
              [class.error]="hasRequiredError('enderecoCliente')">
            <div *ngIf="hasRequiredError('enderecoCliente')" class="error-message">
              {{ getFieldError('enderecoCliente') }}
            </div>
          </div>
        </div>

        <!-- Campos para RETIRADA -->
        <div *ngIf="checkoutForm.get('tipoAtendimento')?.value === 'RETIRADA'" class="conditional-fields">
          <div class="pickup-info">
            <i class='bx bx-time'></i>
            <span>Prepare seu pedido para retirar no local</span>
          </div>

          <!-- Campo para horário de retirada -->
          <div class="form-group">
            <label for="horarioRetirada" class="form-label">Horário de Retirada *</label>
            <input 
              type="time" 
              id="horarioRetirada"
              formControlName="horarioRetirada"
              class="form-input"
              [class.error]="hasRequiredError('horarioRetirada')">
            <div class="time-hint">
              <i class='bx bx-info-circle'></i>
              <span>Informe o horário desejado para retirada (HH:mm)</span>
            </div>
            <div *ngIf="hasRequiredError('horarioRetirada')" class="error-message">
              {{ getFieldError('horarioRetirada') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="cpfRetirada" class="form-label">CPF do Cliente *</label>
            <div class="input-with-button">
              <input 
                type="text" 
                id="cpfRetirada"
                formControlName="cpfCliente"
                maxlength="11" 
                minlength="11" 
                placeholder="00000000000"
                class="form-input"
                [class.error]="hasRequiredError('cpfCliente')">
              <button 
                type="button" 
                class="search-btn"
                (click)="buscarClientePorCpf()" 
                [disabled]="buscandoCliente || !checkoutForm.get('cpfCliente')?.value || checkoutForm.get('cpfCliente')?.value.length !== 11">
                <i class='bx bx-search' *ngIf="!buscandoCliente"></i>
                <i class='bx bx-loader-alt rotating' *ngIf="buscandoCliente"></i>
              </button>
            </div>
            <div *ngIf="hasRequiredError('cpfCliente')" class="error-message">
              {{ getFieldError('cpfCliente') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="nomeRetirada" class="form-label">Nome do Cliente *</label>
            <input 
              type="text" 
              id="nomeRetirada"
              formControlName="nomeCliente"
              placeholder="Nome completo"
              class="form-input"
              [class.readonly]="clienteEncontrado"
              [readonly]="clienteEncontrado"
              [class.error]="hasRequiredError('nomeCliente')">
            <div *ngIf="hasRequiredError('nomeCliente')" class="error-message">
              {{ getFieldError('nomeCliente') }}
            </div>
          </div>
          
          <div class="form-group">
            <label for="telefoneRetirada" class="form-label">Telefone *</label>
            <input 
              type="tel" 
              id="telefoneRetirada"
              formControlName="telefoneCliente"
              placeholder="(00) 00000-0000"
              class="form-input"
              [class.readonly]="clienteEncontrado"
              [readonly]="clienteEncontrado"
              [class.error]="hasRequiredError('telefoneCliente')">
            <div *ngIf="hasRequiredError('telefoneCliente')" class="error-message">
              {{ getFieldError('telefoneCliente') }}
            </div>
          </div>
        </div>

        <!-- Forma de pagamento -->
        <div class="form-group">
          <label class="form-label">Forma de Pagamento *</label>
          <div class="payment-methods">
            <div *ngFor="let pagamento of formasPagamento" class="payment-option-wrapper">
              <input 
                type="radio" 
                [id]="pagamento.value" 
                [value]="pagamento.value" 
                formControlName="formaPagamento"
                name="formaPagamento">
              <label [for]="pagamento.value" class="payment-option">
                <i [ngClass]="pagamento.value === 'DINHEIRO' ? 'bx bx-money' : pagamento.value === 'CARTAO' ? 'bx bx-credit-card' : pagamento.value === 'PIX' ? 'bx bx-qr' : pagamento.value === 'VALES' ? 'bx bx-gift' : 'bx bx-help-circle'"></i>
                {{ pagamento.label }}
              </label>
            </div>
          </div>
          <div *ngIf="hasRequiredError('formaPagamento')" class="error-message">
            {{ getFieldError('formaPagamento') }}
          </div>
        </div>

        <!-- Observações -->
        <div class="form-group">
          <label for="observacoes" class="form-label">Observações do Pedido</label>
          <textarea 
            id="observacoes"
            formControlName="observacoes"
            rows="3"
            placeholder="Observações gerais do pedido..."
            class="form-textarea"></textarea>
        </div>
      </div>

      <!-- Botões de ação -->
      <div class="action-buttons">
        <button 
          type="button" 
          class="clear-btn"
          (click)="clearCart()"
          [disabled]="finalizandoVenda">
          <i class='bx bx-trash'></i>
          Limpar Carrinho
        </button>
        
        <button 
          type="submit" 
          class="submit-btn"
          [disabled]="finalizandoVenda || checkoutForm.invalid || isCartEmpty()"
          [class.loading]="finalizandoVenda">
          <i class='bx bx-send' *ngIf="!finalizandoVenda"></i>
          <i class='bx bx-loader-alt rotating' *ngIf="finalizandoVenda"></i>
          <span>{{ finalizandoVenda ? 'Enviando...' : 'Enviar Pedido' }}</span>
        </button>
      </div>
    </form>
  </div>
</div>
