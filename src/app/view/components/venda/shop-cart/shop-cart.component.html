<div class="carrinho-container">
    <h2>Carrinho de Compras</h2>
    <div *ngIf="itensCarrinho.length === 0" class="carrinho-vazio">
        <p>Carrinho vazio <i class='bx bx-cart'></i></p>
    </div>
    <div *ngFor="let item of itensCarrinho" class="carrinho-item">
        <div class="item-info">
            <span class="item-nome">{{ item.produto }}</span>
            <span class="item-categoria">{{ item.categoria }}</span>
            <span class="item-valor">R$ {{ item.valorTotal.toFixed(2) }}</span>
            <span class="item-observacao" *ngIf="item.observacao">Obs: {{ item.observacao }}</span>
        </div>
        <div class="item-controles">
            <button class="qtd-btn" (click)="alterarQuantidade(item.id, item.quantidade - 1)"
                [disabled]="item.quantidade <= 1">
                <i class='bx bx-minus'></i>
            </button>
            <span class="quantidade">{{ item.quantidade }}</span>
            <button class="qtd-btn" (click)="alterarQuantidade(item.id, item.quantidade + 1)">
                <i class='bx bx-plus'></i>
            </button>
            <button class="remover-btn" (click)="removerItem(item.id)">
                <i class='bx bx-trash'></i>
            </button>
        </div>
    </div>
    <div *ngIf="itensCarrinho.length > 0" class="carrinho-footer">
        <div class="total-container">
            <span class="total-label">Total:</span>
            <span class="total-valor">R$ {{ totalCarrinho.toFixed(2) }}</span>
        </div>
        <form #finalizaForm="ngForm" (ngSubmit)="finalizarVenda()" autocomplete="off">
            <div class="form-row">
                <mat-form-field class="tipo-atendimento-field">
                    <mat-label>Tipo de Atendimento</mat-label>
                    <mat-select [(ngModel)]="tipoAtendimento" name="tipoAtendimento" required>
                        <mat-option value="MESA">Mesa</mat-option>
                        <mat-option value="BALCAO">Balcão</mat-option>
                        <mat-option value="ENTREGA">Entrega</mat-option>
                        <mat-option value="RETIRADA">Retirada</mat-option>
                        <mat-option value="COMANDA">Comanda</mat-option>
                    </mat-select>
                </mat-form-field>
                <ng-container *ngIf="tipoAtendimento === 'MESA'">
                    <mat-form-field class="mesa-field">
                        <mat-label>Nº Mesa</mat-label>
                        <input matInput type="number" [(ngModel)]="mesa" name="mesa" placeholder="Número da mesa"
                            required min="1">
                    </mat-form-field>
                </ng-container>
                <mat-form-field class="pagamento-field">
                    <mat-label>Forma de Pagamento</mat-label>
                    <mat-select [(ngModel)]="formaPagamento" name="formaPagamento" required [disabled]="tipoAtendimento === 'COMANDA'">
                        <mat-option value="DINHEIRO">Dinheiro</mat-option>
                        <mat-option value="CARTAO">Cartão</mat-option>
                        <mat-option value="PIX">Pix</mat-option>
                        <mat-option value="VALES">Vales</mat-option>
                        <mat-option value="COMANDA">Comanda</mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="form-row">
                <mat-form-field class="desconto-field">
                    <mat-label>Desconto (R$)</mat-label>
                    <input matInput type="number" [(ngModel)]="valorDesconto" name="valorDesconto" min="0" step="0.01"
                        placeholder="0,00">
                </mat-form-field>
                <mat-form-field class="acrescimo-field">
                    <mat-label>Acréscimo (R$)</mat-label>
                    <input matInput type="number" [(ngModel)]="valorAcrescimo" name="valorAcrescimo" min="0" step="0.01"
                        placeholder="0,00">
                </mat-form-field>
            </div>
            <ng-container *ngIf="tipoAtendimento === 'ENTREGA' || tipoAtendimento === 'RETIRADA' || tipoAtendimento === 'COMANDA'">
                <div class="cpf-aprova-row">
                    <mat-form-field class="cpf-field">
                        <mat-label>CPF do Cliente</mat-label>
                        <input matInput type="text" [(ngModel)]="cpfCliente" name="cpfCliente" required
                            placeholder="Digite o CPF">
                    </mat-form-field>
                    <button mat-fab color="primary" class="cpf-aprova-btn" type="button" (click)="buscarClientePorCpf()"
                        [disabled]="!cpfCliente || buscandoCliente">
                        <i class='bx bx-search-alt'></i>
                    </button>
                </div>
                <ng-container *ngIf="buscandoCliente">
                    <div class="spinner-container">
                        <mat-spinner diameter="24"></mat-spinner> <span>Buscando cliente...</span>
                    </div>
                </ng-container>
                <ng-container *ngIf="clienteEncontrado">
                    <mat-form-field class="nome-cliente-field">
                        <mat-label>Nome do Cliente</mat-label>
                        <input matInput type="text" [(ngModel)]="nomeCliente" name="nomeCliente" [readonly]="true">
                    </mat-form-field>
                    <ng-container *ngIf="tipoAtendimento === 'ENTREGA'">
                        <mat-form-field class="endereco-field">
                            <mat-label>Endereço</mat-label>
                            <input matInput type="text" [(ngModel)]="enderecoCliente" name="enderecoCliente"
                                [readonly]="true">
                        </mat-form-field>
                    </ng-container>
                    <div class="form-row-flex-end">
                        <mat-form-field class="telefone-field">
                            <mat-label>Telefone</mat-label>
                            <input matInput type="text" [(ngModel)]="telefoneCliente" name="telefoneCliente"
                                [readonly]="true">
                        </mat-form-field>
                        <ng-container *ngIf="tipoAtendimento === 'ENTREGA'">
                            <mat-form-field class="horario-entrega-field">
                                <mat-label>Horário de Entrega</mat-label>
                                <input matInput type="datetime-local" [(ngModel)]="horarioEntrega"
                                    name="horarioEntrega">
                            </mat-form-field>
                        </ng-container>
                        <ng-container *ngIf="tipoAtendimento === 'RETIRADA'">
                            <mat-form-field class="horario-retirada-field">
                                <mat-label>Horário de Retirada</mat-label>
                                <input matInput type="datetime-local" [(ngModel)]="horarioRetirada"
                                    name="horarioRetirada" (ngModelChange)="onHorarioRetiradaChange($event)">
                            </mat-form-field>
                        </ng-container>
                    </div>
                </ng-container>
            </ng-container>
            <mat-form-field class="observacao-venda-field">
                <mat-label>Observação Geral da Venda</mat-label>
                <textarea matInput [(ngModel)]="observacaoVenda" name="observacaoVenda" rows="2"
                    placeholder="Observações gerais da venda"></textarea>
            </mat-form-field>
            <ng-container *ngIf="valorDesconto && valorDesconto > 0">
                <mat-form-field class="nome-desconto-field">
                    <mat-label>Nome do Desconto</mat-label>
                    <input matInput type="text" [(ngModel)]="nomeDesconto" name="nomeDesconto" required
                        placeholder="Ex: Desconto fidelidade">
                </mat-form-field>
            </ng-container>
            <ng-container *ngIf="valorAcrescimo && valorAcrescimo > 0">
                <mat-form-field class="nome-acrescimo-field">
                    <mat-label>Nome do Acréscimo</mat-label>
                    <input matInput type="text" [(ngModel)]="nomeAcrescimo" name="nomeAcrescimo" required
                        placeholder="Ex: Taxa de entrega">
                </mat-form-field>
            </ng-container>
            <button class="finalizar-btn" type="submit"
                [disabled]="finalizandoVenda || !tipoAtendimento || !formaPagamento || (tipoAtendimento === 'MESA' && !mesa) || ((tipoAtendimento === 'ENTREGA' || tipoAtendimento === 'RETIRADA' || tipoAtendimento === 'COMANDA') && (!cpfCliente || !clienteEncontrado)) || (valorDesconto && !nomeDesconto) || (valorAcrescimo && !nomeAcrescimo) || (tipoAtendimento === 'ENTREGA' && !horarioEntrega) || (tipoAtendimento === 'RETIRADA' && !horarioRetirada)">
                <i class='bx bx-check-circle'></i>
                Finalizar Venda
            </button>
        </form>
    </div>
</div>